'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Universe = function () {
	function Universe(canvas) {
		var _this = this;

		_classCallCheck(this, Universe);

		this._canvas = canvas;

		this.width = 1440;
		this.height = 768;
		this.craterSize = 25;
		this.playerMargin = 100;
		this.playerRadius = 20;
		this.maxShotVelocity = 400;
		this.shotPowerUpSpeed = this.maxShotVelocity / 2000;

		this.starSystem = new StarSystem(this);
		this.players = [];
		this.particles = new Set();

		var _state = Universe.PREGAME,
		    _currentPlayer = 0;
		var self = this;
		this.gameState = {
			get currentPlayer() {
				return _currentPlayer;
			},
			set currentPlayer(val) {
				_currentPlayer = val;
				self._triggerEvent('change-player', val);
			},
			get state() {
				return _state;
			},
			set state(val) {
				_state = val;
				self._triggerEvent('state-change', val);
			},
			shot: {
				angle: Vector.zero,
				power: 0
			}
		};
		setTimeout(function () {
			self._triggerEvent('state-change', _state);
			self._triggerEvent('change-player', _currentPlayer);
		});

		this.timestream = new Timestream();
		this.timestream.maxInterval = 100;
		this.timestream.on('frame', function (interval) {
			return _this.withTransformedCanvas(function (ctx) {
				if (_this.gameState.state == Universe.POWERING) {
					_this.gameState.shot.power += _this.shotPowerUpSpeed * interval;
					if (_this.gameState.shot.power >= _this.maxShotVelocity) _this.gameState.shot.power = _this.maxShotVelocity;
					_this.updateShotAngle();
				}
				var ongoingShot = false;
				_this.drawBackground(ctx);
				if (_this.gameState.state == Universe.TARGETTING || _this.gameState.state == Universe.POWERING) {
					ctx.fillStyle = 'transparent';
					ctx.strokeStyle = '#00ff00';
					ctx.lineWidth = 2;
					new Circle(_this.currentPlayer.location, 30).draw(ctx);
					new LineSegment(_this.currentPlayer.location.plus(_this.gameState.shot.angle.times(30)), _this.currentPlayer.location.plus(_this.gameState.shot.angle.times(30 + Math.max(10, _this.gameState.shot.power / _this.maxShotVelocity * 100)))).draw(ctx);
				}
				_this.particles.forEach(function (particle) {
					if (interval == _this.maxInterval && particle.disposable) particle.destroy();
					if (particle.destroyed) {
						_this.removeParticle(particle);
						return;
					}
					var motion = particle.advance(interval / 1000, _this.starSystem);
					if (particle.checkCollisions) {
						var planetCollision = _this.starSystem.collision(motion, particle.radius);
						if (planetCollision) {
							particle.impact(planetCollision);
							if (particle.destroysPlanet) {
								planetCollision.obstacle.addCrater(planetCollision.location, _this.craterSize);
								// Bits of planet
								Explosions.single(_this, planetCollision.location, {
									velocity: Vector.zero,
									violence: 400,
									destroyOnImpact: true,
									debrisCount: 250,
									lifetime: 100000,
									debrisRadius: 3,
									globalCompositeOperation: 'source-over',
									baseColour: planetCollision.obstacle.hue + ', 75%, 45%',
									colourModel: 'hsl',
									smooth: false
								});
							}
						}
						if (particle.isBullet) {
							ongoingShot = true;
							if (particle.hasClearedShooter) _this.players.forEach(function (player) {
								var playerCollision = player.collision(motion, particle.radius);
								if (playerCollision) {
									player.explode();
									particle.impact(playerCollision);
									document.getElementById('winner').innerHTML = _this.otherPlayer(player).name;
									_this.gameState.state = Universe.GAME_OVER;
								}
							});else if (particle.location.distanceTo(particle.owner.location) > particle.radius + particle.owner.hitArea.radius) particle.hasClearedShooter = true;
						}
					}
					particle.draw(ctx);
				});
				if (!ongoingShot && _this.gameState.state == Universe.ONGOING_SHOT) {
					_this.gameState.state = Universe.TARGETTING;
					_this.gameState.shot.power = 0;
				}
			});
		});

		this.addPlayer(new Vector(this.playerMargin, this.height / 2), this.playerRadius, 'img/ship1.png').name = 'Player One';
		this.addPlayer(new Vector(this.width - this.playerMargin, this.height / 2), this.playerRadius, 'img/ship2.png').name = 'Player Two';

		this._canvasListeners = {};

		this.addCanvasListener('mousedown', function (e) {
			if (_this.gameState.state == Universe.TARGETTING) {
				_this.gameState.shot.power = 0;
				_this.updateShotAngle(e);
				_this.gameState.state = Universe.POWERING;
			}
		});

		this.addCanvasListener('mouseup', function (e) {
			if (_this.gameState.state != Universe.POWERING) return;
			_this.updateShotAngle(e);
			if (_this.gameState.shot.power >= _this.maxShotVelocity) _this.gameState.shot.power = _this.maxShotVelocity;
			_this.currentPlayer.shoot(_this.gameState.shot.angle.times(_this.gameState.shot.power));
			_this.endTurn();
		});

		this.addCanvasListener('mouseout', function (e) {
			if (_this.gameState.state == Universe.POWERING) _this.gameState.state = Universe.TARGETTING;
		});

		this.addCanvasListener('mousemove', function (e) {
			if (_this.gameState.state == Universe.POWERING || _this.gameState.state == Universe.TARGETTING) _this.updateShotAngle(e);
		});
	}

	_createClass(Universe, [{
		key: 'startGame',
		value: function startGame() {
			this.gameState.state = Universe.TARGETTING;
		}
	}, {
		key: 'updateShotAngle',
		value: function updateShotAngle(e) {
			if (e) {
				this.gameState.shot.angle = this.mouseVector(e).minus(this.currentPlayer.location).normalise();
				document.getElementById('shot-angle').innerHTML = Math.round(this.gameState.shot.angle.angle * 180 / Math.PI);
			}
			document.getElementById('shot-power').innerHTML = Math.round(this.gameState.shot.power * 100 / this.maxShotVelocity);
		}
	}, {
		key: 'addCanvasListener',
		value: function addCanvasListener(event, callback) {
			if (!this._canvasListeners[event]) this._canvasListeners[event] = [];
			this._canvasListeners[event].push(callback);
			this._canvas.addEventListener(event, callback);
		}
	}, {
		key: 'otherPlayer',
		value: function otherPlayer(player) {
			return this.players[1 - this.players.indexOf(player)];
		}
	}, {
		key: 'mouseToShot',
		value: function mouseToShot(e) {
			var mouse = this.mouseVector(e);
			var shot = mouse.minus(this.currentPlayer.location).times(this.shotVelicityMultiplier);
			if (shot.length > this.maxShotVelocity) shot = shot.normalise().times(this.maxShotVelocity);
			return shot;
		}
	}, {
		key: 'mouseVector',
		value: function mouseVector(e) {
			return Vector.canvasMouseVector(this._canvas, e).minus(new Vector(this._canvas.width / 2, this._canvas.height / 2)).over(this._lastScale || 1).plus(new Vector(this.width / 2, this.height / 2));
		}
	}, {
		key: 'addPlayer',
		value: function addPlayer(location, size, filename) {
			var player = new Player(this, location, size, filename);
			this.players.push(player);
			return player;
		}
	}, {
		key: 'addParticle',
		value: function addParticle() {
			for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
				args[_key] = arguments[_key];
			}

			var p = new (Function.prototype.bind.apply(Particle, [null].concat([this], args)))();
			this.particles.add(p);
			return p;
		}
	}, {
		key: 'removeParticle',
		value: function removeParticle(particle) {
			this.particles.delete(particle);
		}
	}, {
		key: 'drawBackground',
		value: function drawBackground(ctx) {
			this.starSystem.draw(ctx);
			this.players.forEach(function (player) {
				return player.draw(ctx);
			});
		}
	}, {
		key: 'withTransformedCanvas',
		value: function withTransformedCanvas(code) {
			var canvas = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this._canvas;
			var ctx = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : canvas.getContext('2d');
			var clear = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;

			if (clear) ctx.clearRect(-10, -10, canvas.width + 20, canvas.height + 20);
			var scale = Math.min(canvas.width / this.width, canvas.height / this.height);
			ctx.save();
			ctx.translate(canvas.width / 2, canvas.height / 2);
			ctx.scale(scale, scale);
			ctx.translate(-this.width / 2, -this.height / 2);
			if (canvas == this._canvas) {
				if (this._lastScale != scale) console.log('Viewing at ' + scale * 100 + '% scale');
				this._lastScale = scale;
			}
			code(ctx);
			ctx.restore();
		}
	}, {
		key: 'gravityAt',
		value: function gravityAt(location) {
			return this.starSystem.gravityAt(location);
		}
	}, {
		key: 'endTurn',
		value: function endTurn() {
			this.gameState.currentPlayer = 1 - this.gameState.currentPlayer;
			this.gameState.state = Universe.ONGOING_SHOT;
		}
	}, {
		key: 'destroy',
		value: function destroy() {
			var _this2 = this;

			this._cancelUpdates();

			var _loop = function _loop(event) {
				_this2._canvasListeners[event].forEach(function (listener) {
					return _this2._canvas.removeEventListener(event, listener);
				});
			};

			for (var event in this._canvasListeners) {
				_loop(event);
			}
		}
	}, {
		key: 'currentPlayer',
		get: function get() {
			return this.players[this.gameState.currentPlayer];
		}
	}]);

	return Universe;
}();

Universe.PREGAME = Symbol('Pre-game');
Universe.TARGETTING = Symbol('Targetting');
Universe.POWERING = Symbol('Powering Up');
Universe.ONGOING_SHOT = Symbol('Ongoing Shot');
Universe.GAME_OVER = Symbol('Game Over');

eventise(Universe);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3VuaXZlcnNlLmpzIl0sIm5hbWVzIjpbIlVuaXZlcnNlIiwiY2FudmFzIiwiX2NhbnZhcyIsIndpZHRoIiwiaGVpZ2h0IiwiY3JhdGVyU2l6ZSIsInBsYXllck1hcmdpbiIsInBsYXllclJhZGl1cyIsIm1heFNob3RWZWxvY2l0eSIsInNob3RQb3dlclVwU3BlZWQiLCJzdGFyU3lzdGVtIiwiU3RhclN5c3RlbSIsInBsYXllcnMiLCJwYXJ0aWNsZXMiLCJTZXQiLCJfc3RhdGUiLCJQUkVHQU1FIiwiX2N1cnJlbnRQbGF5ZXIiLCJzZWxmIiwiZ2FtZVN0YXRlIiwiY3VycmVudFBsYXllciIsInZhbCIsIl90cmlnZ2VyRXZlbnQiLCJzdGF0ZSIsInNob3QiLCJhbmdsZSIsIlZlY3RvciIsInplcm8iLCJwb3dlciIsInNldFRpbWVvdXQiLCJ0aW1lc3RyZWFtIiwiVGltZXN0cmVhbSIsIm1heEludGVydmFsIiwib24iLCJ3aXRoVHJhbnNmb3JtZWRDYW52YXMiLCJQT1dFUklORyIsImludGVydmFsIiwidXBkYXRlU2hvdEFuZ2xlIiwib25nb2luZ1Nob3QiLCJkcmF3QmFja2dyb3VuZCIsImN0eCIsIlRBUkdFVFRJTkciLCJmaWxsU3R5bGUiLCJzdHJva2VTdHlsZSIsImxpbmVXaWR0aCIsIkNpcmNsZSIsImxvY2F0aW9uIiwiZHJhdyIsIkxpbmVTZWdtZW50IiwicGx1cyIsInRpbWVzIiwiTWF0aCIsIm1heCIsImZvckVhY2giLCJwYXJ0aWNsZSIsImRpc3Bvc2FibGUiLCJkZXN0cm95IiwiZGVzdHJveWVkIiwicmVtb3ZlUGFydGljbGUiLCJtb3Rpb24iLCJhZHZhbmNlIiwiY2hlY2tDb2xsaXNpb25zIiwicGxhbmV0Q29sbGlzaW9uIiwiY29sbGlzaW9uIiwicmFkaXVzIiwiaW1wYWN0IiwiZGVzdHJveXNQbGFuZXQiLCJvYnN0YWNsZSIsImFkZENyYXRlciIsIkV4cGxvc2lvbnMiLCJzaW5nbGUiLCJ2ZWxvY2l0eSIsInZpb2xlbmNlIiwiZGVzdHJveU9uSW1wYWN0IiwiZGVicmlzQ291bnQiLCJsaWZldGltZSIsImRlYnJpc1JhZGl1cyIsImdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiIsImJhc2VDb2xvdXIiLCJodWUiLCJjb2xvdXJNb2RlbCIsInNtb290aCIsImlzQnVsbGV0IiwiaGFzQ2xlYXJlZFNob290ZXIiLCJwbGF5ZXJDb2xsaXNpb24iLCJwbGF5ZXIiLCJleHBsb2RlIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImlubmVySFRNTCIsIm90aGVyUGxheWVyIiwibmFtZSIsIkdBTUVfT1ZFUiIsImRpc3RhbmNlVG8iLCJvd25lciIsImhpdEFyZWEiLCJPTkdPSU5HX1NIT1QiLCJhZGRQbGF5ZXIiLCJfY2FudmFzTGlzdGVuZXJzIiwiYWRkQ2FudmFzTGlzdGVuZXIiLCJlIiwic2hvb3QiLCJlbmRUdXJuIiwibW91c2VWZWN0b3IiLCJtaW51cyIsIm5vcm1hbGlzZSIsInJvdW5kIiwiUEkiLCJldmVudCIsImNhbGxiYWNrIiwicHVzaCIsImFkZEV2ZW50TGlzdGVuZXIiLCJpbmRleE9mIiwibW91c2UiLCJzaG90VmVsaWNpdHlNdWx0aXBsaWVyIiwibGVuZ3RoIiwiY2FudmFzTW91c2VWZWN0b3IiLCJvdmVyIiwiX2xhc3RTY2FsZSIsInNpemUiLCJmaWxlbmFtZSIsIlBsYXllciIsImFyZ3MiLCJwIiwiUGFydGljbGUiLCJhZGQiLCJkZWxldGUiLCJjb2RlIiwiZ2V0Q29udGV4dCIsImNsZWFyIiwiY2xlYXJSZWN0Iiwic2NhbGUiLCJtaW4iLCJzYXZlIiwidHJhbnNsYXRlIiwiY29uc29sZSIsImxvZyIsInJlc3RvcmUiLCJncmF2aXR5QXQiLCJfY2FuY2VsVXBkYXRlcyIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJsaXN0ZW5lciIsIlN5bWJvbCIsImV2ZW50aXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7SUFBTUEsUTtBQUNMLG1CQUFZQyxNQUFaLEVBQW9CO0FBQUE7O0FBQUE7O0FBQ25CLE9BQUtDLE9BQUwsR0FBZUQsTUFBZjs7QUFFQSxPQUFLRSxLQUFMLEdBQWEsSUFBYjtBQUNBLE9BQUtDLE1BQUwsR0FBYyxHQUFkO0FBQ0EsT0FBS0MsVUFBTCxHQUFrQixFQUFsQjtBQUNBLE9BQUtDLFlBQUwsR0FBb0IsR0FBcEI7QUFDQSxPQUFLQyxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsT0FBS0MsZUFBTCxHQUF1QixHQUF2QjtBQUNBLE9BQUtDLGdCQUFMLEdBQXdCLEtBQUtELGVBQUwsR0FBdUIsSUFBL0M7O0FBRUEsT0FBS0UsVUFBTCxHQUFrQixJQUFJQyxVQUFKLENBQWUsSUFBZixDQUFsQjtBQUNBLE9BQUtDLE9BQUwsR0FBZSxFQUFmO0FBQ0EsT0FBS0MsU0FBTCxHQUFpQixJQUFJQyxHQUFKLEVBQWpCOztBQUVBLE1BQUlDLFNBQVNmLFNBQVNnQixPQUF0QjtBQUFBLE1BQ0NDLGlCQUFpQixDQURsQjtBQUVBLE1BQU1DLE9BQU8sSUFBYjtBQUNBLE9BQUtDLFNBQUwsR0FBaUI7QUFDaEIsT0FBSUMsYUFBSixHQUFvQjtBQUFFLFdBQU9ILGNBQVA7QUFBd0IsSUFEOUI7QUFFaEIsT0FBSUcsYUFBSixDQUFrQkMsR0FBbEIsRUFBdUI7QUFDdEJKLHFCQUFpQkksR0FBakI7QUFDQUgsU0FBS0ksYUFBTCxDQUFtQixlQUFuQixFQUFvQ0QsR0FBcEM7QUFDQSxJQUxlO0FBTWhCLE9BQUlFLEtBQUosR0FBWTtBQUFFLFdBQU9SLE1BQVA7QUFBZ0IsSUFOZDtBQU9oQixPQUFJUSxLQUFKLENBQVVGLEdBQVYsRUFBZTtBQUNkTixhQUFTTSxHQUFUO0FBQ0FILFNBQUtJLGFBQUwsQ0FBbUIsY0FBbkIsRUFBbUNELEdBQW5DO0FBQ0EsSUFWZTtBQVdoQkcsU0FBTTtBQUNMQyxXQUFPQyxPQUFPQyxJQURUO0FBRUxDLFdBQU87QUFGRjtBQVhVLEdBQWpCO0FBZ0JBQyxhQUFXLFlBQU07QUFDaEJYLFFBQUtJLGFBQUwsQ0FBbUIsY0FBbkIsRUFBbUNQLE1BQW5DO0FBQ0FHLFFBQUtJLGFBQUwsQ0FBbUIsZUFBbkIsRUFBb0NMLGNBQXBDO0FBQ0EsR0FIRDs7QUFLQSxPQUFLYSxVQUFMLEdBQWtCLElBQUlDLFVBQUosRUFBbEI7QUFDQSxPQUFLRCxVQUFMLENBQWdCRSxXQUFoQixHQUE4QixHQUE5QjtBQUNBLE9BQUtGLFVBQUwsQ0FBZ0JHLEVBQWhCLENBQW1CLE9BQW5CLEVBQTRCO0FBQUEsVUFBWSxNQUFLQyxxQkFBTCxDQUEyQixlQUFPO0FBQ3pFLFFBQUksTUFBS2YsU0FBTCxDQUFlSSxLQUFmLElBQXdCdkIsU0FBU21DLFFBQXJDLEVBQStDO0FBQzlDLFdBQUtoQixTQUFMLENBQWVLLElBQWYsQ0FBb0JJLEtBQXBCLElBQTZCLE1BQUtuQixnQkFBTCxHQUF3QjJCLFFBQXJEO0FBQ0EsU0FBSSxNQUFLakIsU0FBTCxDQUFlSyxJQUFmLENBQW9CSSxLQUFwQixJQUE2QixNQUFLcEIsZUFBdEMsRUFDQyxNQUFLVyxTQUFMLENBQWVLLElBQWYsQ0FBb0JJLEtBQXBCLEdBQTRCLE1BQUtwQixlQUFqQztBQUNELFdBQUs2QixlQUFMO0FBQ0E7QUFDRCxRQUFJQyxjQUFjLEtBQWxCO0FBQ0EsVUFBS0MsY0FBTCxDQUFvQkMsR0FBcEI7QUFDQSxRQUFJLE1BQUtyQixTQUFMLENBQWVJLEtBQWYsSUFBd0J2QixTQUFTeUMsVUFBakMsSUFDSCxNQUFLdEIsU0FBTCxDQUFlSSxLQUFmLElBQXdCdkIsU0FBU21DLFFBRGxDLEVBQzRDO0FBQzNDSyxTQUFJRSxTQUFKLEdBQWdCLGFBQWhCO0FBQ0FGLFNBQUlHLFdBQUosR0FBa0IsU0FBbEI7QUFDQUgsU0FBSUksU0FBSixHQUFnQixDQUFoQjtBQUNBLFNBQUlDLE1BQUosQ0FBVyxNQUFLekIsYUFBTCxDQUFtQjBCLFFBQTlCLEVBQXdDLEVBQXhDLEVBQTRDQyxJQUE1QyxDQUFpRFAsR0FBakQ7QUFDQSxTQUFJUSxXQUFKLENBQ0UsTUFBSzVCLGFBQUwsQ0FBbUIwQixRQUFuQixDQUNFRyxJQURGLENBQ08sTUFBSzlCLFNBQUwsQ0FBZUssSUFBZixDQUFvQkMsS0FBcEIsQ0FBMEJ5QixLQUExQixDQUFnQyxFQUFoQyxDQURQLENBREYsRUFHRSxNQUFLOUIsYUFBTCxDQUFtQjBCLFFBQW5CLENBQ0VHLElBREYsQ0FDTyxNQUFLOUIsU0FBTCxDQUFlSyxJQUFmLENBQW9CQyxLQUFwQixDQUEwQnlCLEtBQTFCLENBQWdDLEtBQ3JDQyxLQUFLQyxHQUFMLENBQVMsRUFBVCxFQUFhLE1BQUtqQyxTQUFMLENBQWVLLElBQWYsQ0FBb0JJLEtBQXBCLEdBQ1YsTUFBS3BCLGVBREssR0FDYSxHQUQxQixDQURLLENBRFAsQ0FIRixFQU9FdUMsSUFQRixDQU9PUCxHQVBQO0FBUUE7QUFDRCxVQUFLM0IsU0FBTCxDQUFld0MsT0FBZixDQUF1QixvQkFBWTtBQUNsQyxTQUFJakIsWUFBWSxNQUFLSixXQUFqQixJQUNIc0IsU0FBU0MsVUFEVixFQUVDRCxTQUFTRSxPQUFUO0FBQ0QsU0FBSUYsU0FBU0csU0FBYixFQUF3QjtBQUN2QixZQUFLQyxjQUFMLENBQW9CSixRQUFwQjtBQUNBO0FBQ0E7QUFDRCxTQUFNSyxTQUFTTCxTQUFTTSxPQUFULENBQ2J4QixXQUFXLElBREUsRUFDSSxNQUFLMUIsVUFEVCxDQUFmO0FBRUEsU0FBSTRDLFNBQVNPLGVBQWIsRUFBOEI7QUFDN0IsVUFBTUMsa0JBQWtCLE1BQUtwRCxVQUFMLENBQWdCcUQsU0FBaEIsQ0FDdEJKLE1BRHNCLEVBQ2RMLFNBQVNVLE1BREssQ0FBeEI7QUFFQSxVQUFJRixlQUFKLEVBQXFCO0FBQ3BCUixnQkFBU1csTUFBVCxDQUFnQkgsZUFBaEI7QUFDQSxXQUFJUixTQUFTWSxjQUFiLEVBQTZCO0FBQzVCSix3QkFBZ0JLLFFBQWhCLENBQXlCQyxTQUF6QixDQUNDTixnQkFBZ0JoQixRQURqQixFQUVDLE1BQUt6QyxVQUZOO0FBR0E7QUFDQWdFLG1CQUFXQyxNQUFYLFFBQXdCUixnQkFBZ0JoQixRQUF4QyxFQUNDO0FBQ0N5QixtQkFBVTdDLE9BQU9DLElBRGxCO0FBRUM2QyxtQkFBVSxHQUZYO0FBR0NDLDBCQUFpQixJQUhsQjtBQUlDQyxzQkFBYSxHQUpkO0FBS0NDLG1CQUFVLE1BTFg7QUFNQ0MsdUJBQWMsQ0FOZjtBQU9DQyxtQ0FBMEIsYUFQM0I7QUFRQ0MscUJBQWVoQixnQkFBZ0JLLFFBQWhCLENBQXlCWSxHQUF4QyxlQVJEO0FBU0NDLHNCQUFhLEtBVGQ7QUFVQ0MsaUJBQVE7QUFWVCxTQUREO0FBYUE7QUFDRDtBQUNELFVBQUkzQixTQUFTNEIsUUFBYixFQUF1QjtBQUN0QjVDLHFCQUFjLElBQWQ7QUFDQSxXQUFJZ0IsU0FBUzZCLGlCQUFiLEVBQ0MsTUFBS3ZFLE9BQUwsQ0FBYXlDLE9BQWIsQ0FBcUIsa0JBQVU7QUFDOUIsWUFBTStCLGtCQUNMQyxPQUFPdEIsU0FBUCxDQUFpQkosTUFBakIsRUFBeUJMLFNBQVNVLE1BQWxDLENBREQ7QUFFQSxZQUFJb0IsZUFBSixFQUFxQjtBQUNwQkMsZ0JBQU9DLE9BQVA7QUFDQWhDLGtCQUFTVyxNQUFULENBQWdCbUIsZUFBaEI7QUFDQUcsa0JBQVNDLGNBQVQsQ0FBd0IsUUFBeEIsRUFDRUMsU0FERixHQUNjLE1BQUtDLFdBQUwsQ0FBaUJMLE1BQWpCLEVBQXlCTSxJQUR2QztBQUVBLGVBQUt4RSxTQUFMLENBQWVJLEtBQWYsR0FBdUJ2QixTQUFTNEYsU0FBaEM7QUFDQTtBQUNELFFBVkQsRUFERCxLQVlLLElBQUl0QyxTQUFTUixRQUFULENBQWtCK0MsVUFBbEIsQ0FBNkJ2QyxTQUFTd0MsS0FBVCxDQUFlaEQsUUFBNUMsSUFDUFEsU0FBU1UsTUFBVCxHQUFrQlYsU0FBU3dDLEtBQVQsQ0FBZUMsT0FBZixDQUF1Qi9CLE1BRHRDLEVBRUpWLFNBQVM2QixpQkFBVCxHQUE2QixJQUE3QjtBQUNEO0FBQ0Q7QUFDRDdCLGNBQVNQLElBQVQsQ0FBY1AsR0FBZDtBQUNBLEtBdkREO0FBd0RBLFFBQUksQ0FBQ0YsV0FBRCxJQUNILE1BQUtuQixTQUFMLENBQWVJLEtBQWYsSUFBd0J2QixTQUFTZ0csWUFEbEMsRUFDZ0Q7QUFDL0MsV0FBSzdFLFNBQUwsQ0FBZUksS0FBZixHQUF1QnZCLFNBQVN5QyxVQUFoQztBQUNBLFdBQUt0QixTQUFMLENBQWVLLElBQWYsQ0FBb0JJLEtBQXBCLEdBQTRCLENBQTVCO0FBQ0E7QUFDRCxJQXJGdUMsQ0FBWjtBQUFBLEdBQTVCOztBQXVGQSxPQUFLcUUsU0FBTCxDQUNDLElBQUl2RSxNQUFKLENBQVcsS0FBS3BCLFlBQWhCLEVBQThCLEtBQUtGLE1BQUwsR0FBYyxDQUE1QyxDQURELEVBRUMsS0FBS0csWUFGTixFQUdDLGVBSEQsRUFJR29GLElBSkgsR0FJVSxZQUpWO0FBS0EsT0FBS00sU0FBTCxDQUNDLElBQUl2RSxNQUFKLENBQVcsS0FBS3ZCLEtBQUwsR0FBYSxLQUFLRyxZQUE3QixFQUEyQyxLQUFLRixNQUFMLEdBQWMsQ0FBekQsQ0FERCxFQUVDLEtBQUtHLFlBRk4sRUFHQyxlQUhELEVBSUdvRixJQUpILEdBSVUsWUFKVjs7QUFNQSxPQUFLTyxnQkFBTCxHQUF3QixFQUF4Qjs7QUFFQSxPQUFLQyxpQkFBTCxDQUF1QixXQUF2QixFQUFvQyxhQUFLO0FBQ3hDLE9BQUksTUFBS2hGLFNBQUwsQ0FBZUksS0FBZixJQUF3QnZCLFNBQVN5QyxVQUFyQyxFQUFpRDtBQUNoRCxVQUFLdEIsU0FBTCxDQUFlSyxJQUFmLENBQW9CSSxLQUFwQixHQUE0QixDQUE1QjtBQUNBLFVBQUtTLGVBQUwsQ0FBcUIrRCxDQUFyQjtBQUNBLFVBQUtqRixTQUFMLENBQWVJLEtBQWYsR0FBdUJ2QixTQUFTbUMsUUFBaEM7QUFDQTtBQUNELEdBTkQ7O0FBUUEsT0FBS2dFLGlCQUFMLENBQXVCLFNBQXZCLEVBQWtDLGFBQUs7QUFDdEMsT0FBSSxNQUFLaEYsU0FBTCxDQUFlSSxLQUFmLElBQXdCdkIsU0FBU21DLFFBQXJDLEVBQ0M7QUFDRCxTQUFLRSxlQUFMLENBQXFCK0QsQ0FBckI7QUFDQSxPQUFJLE1BQUtqRixTQUFMLENBQWVLLElBQWYsQ0FBb0JJLEtBQXBCLElBQTZCLE1BQUtwQixlQUF0QyxFQUNDLE1BQUtXLFNBQUwsQ0FBZUssSUFBZixDQUFvQkksS0FBcEIsR0FBNEIsTUFBS3BCLGVBQWpDO0FBQ0QsU0FBS1ksYUFBTCxDQUFtQmlGLEtBQW5CLENBQXlCLE1BQUtsRixTQUFMLENBQWVLLElBQWYsQ0FBb0JDLEtBQXBCLENBQ3RCeUIsS0FEc0IsQ0FDaEIsTUFBSy9CLFNBQUwsQ0FBZUssSUFBZixDQUFvQkksS0FESixDQUF6QjtBQUVBLFNBQUswRSxPQUFMO0FBQ0EsR0FURDs7QUFXQSxPQUFLSCxpQkFBTCxDQUF1QixVQUF2QixFQUFtQyxhQUFLO0FBQ3ZDLE9BQUksTUFBS2hGLFNBQUwsQ0FBZUksS0FBZixJQUF3QnZCLFNBQVNtQyxRQUFyQyxFQUNDLE1BQUtoQixTQUFMLENBQWVJLEtBQWYsR0FBdUJ2QixTQUFTeUMsVUFBaEM7QUFDRCxHQUhEOztBQUtBLE9BQUswRCxpQkFBTCxDQUF1QixXQUF2QixFQUFvQyxhQUFLO0FBQ3hDLE9BQUksTUFBS2hGLFNBQUwsQ0FBZUksS0FBZixJQUF3QnZCLFNBQVNtQyxRQUFqQyxJQUNILE1BQUtoQixTQUFMLENBQWVJLEtBQWYsSUFBd0J2QixTQUFTeUMsVUFEbEMsRUFFQyxNQUFLSixlQUFMLENBQXFCK0QsQ0FBckI7QUFDRCxHQUpEO0FBS0E7Ozs7OEJBRVc7QUFDWCxRQUFLakYsU0FBTCxDQUFlSSxLQUFmLEdBQXVCdkIsU0FBU3lDLFVBQWhDO0FBQ0E7OztrQ0FFZTJELEMsRUFBRztBQUNsQixPQUFJQSxDQUFKLEVBQU87QUFDTixTQUFLakYsU0FBTCxDQUFlSyxJQUFmLENBQW9CQyxLQUFwQixHQUE0QixLQUFLOEUsV0FBTCxDQUFpQkgsQ0FBakIsRUFDMUJJLEtBRDBCLENBQ3BCLEtBQUtwRixhQUFMLENBQW1CMEIsUUFEQyxFQUUxQjJELFNBRjBCLEVBQTVCO0FBR0FsQixhQUFTQyxjQUFULENBQXdCLFlBQXhCLEVBQXNDQyxTQUF0QyxHQUNDdEMsS0FBS3VELEtBQUwsQ0FBVyxLQUFLdkYsU0FBTCxDQUFlSyxJQUFmLENBQW9CQyxLQUFwQixDQUEwQkEsS0FBMUIsR0FDUixHQURRLEdBQ0YwQixLQUFLd0QsRUFEZCxDQUREO0FBR0E7QUFDRHBCLFlBQVNDLGNBQVQsQ0FBd0IsWUFBeEIsRUFBc0NDLFNBQXRDLEdBQ0N0QyxLQUFLdUQsS0FBTCxDQUFXLEtBQUt2RixTQUFMLENBQWVLLElBQWYsQ0FBb0JJLEtBQXBCLEdBQ1IsR0FEUSxHQUNGLEtBQUtwQixlQURkLENBREQ7QUFHQTs7O29DQUVpQm9HLEssRUFBT0MsUSxFQUFVO0FBQ2xDLE9BQUksQ0FBQyxLQUFLWCxnQkFBTCxDQUFzQlUsS0FBdEIsQ0FBTCxFQUNDLEtBQUtWLGdCQUFMLENBQXNCVSxLQUF0QixJQUErQixFQUEvQjtBQUNELFFBQUtWLGdCQUFMLENBQXNCVSxLQUF0QixFQUE2QkUsSUFBN0IsQ0FBa0NELFFBQWxDO0FBQ0EsUUFBSzNHLE9BQUwsQ0FBYTZHLGdCQUFiLENBQThCSCxLQUE5QixFQUFxQ0MsUUFBckM7QUFDQTs7OzhCQUVXeEIsTSxFQUFRO0FBQ25CLFVBQU8sS0FBS3pFLE9BQUwsQ0FBYSxJQUFJLEtBQUtBLE9BQUwsQ0FBYW9HLE9BQWIsQ0FBcUIzQixNQUFyQixDQUFqQixDQUFQO0FBQ0E7Ozs4QkFFV2UsQyxFQUFHO0FBQ2QsT0FBTWEsUUFBUSxLQUFLVixXQUFMLENBQWlCSCxDQUFqQixDQUFkO0FBQ0EsT0FBSTVFLE9BQU95RixNQUFNVCxLQUFOLENBQVksS0FBS3BGLGFBQUwsQ0FBbUIwQixRQUEvQixFQUNSSSxLQURRLENBQ0YsS0FBS2dFLHNCQURILENBQVg7QUFFQSxPQUFJMUYsS0FBSzJGLE1BQUwsR0FBYyxLQUFLM0csZUFBdkIsRUFDQ2dCLE9BQU9BLEtBQUtpRixTQUFMLEdBQWlCdkQsS0FBakIsQ0FBdUIsS0FBSzFDLGVBQTVCLENBQVA7QUFDRCxVQUFPZ0IsSUFBUDtBQUNBOzs7OEJBRVc0RSxDLEVBQUc7QUFDZCxVQUFPMUUsT0FBTzBGLGlCQUFQLENBQXlCLEtBQUtsSCxPQUE5QixFQUF1Q2tHLENBQXZDLEVBQ0xJLEtBREssQ0FDQyxJQUFJOUUsTUFBSixDQUFXLEtBQUt4QixPQUFMLENBQWFDLEtBQWIsR0FBcUIsQ0FBaEMsRUFBbUMsS0FBS0QsT0FBTCxDQUFhRSxNQUFiLEdBQXNCLENBQXpELENBREQsRUFFTGlILElBRkssQ0FFQSxLQUFLQyxVQUFMLElBQW1CLENBRm5CLEVBR0xyRSxJQUhLLENBR0EsSUFBSXZCLE1BQUosQ0FBVyxLQUFLdkIsS0FBTCxHQUFhLENBQXhCLEVBQTJCLEtBQUtDLE1BQUwsR0FBYyxDQUF6QyxDQUhBLENBQVA7QUFJQTs7OzRCQUVTMEMsUSxFQUFVeUUsSSxFQUFNQyxRLEVBQVU7QUFDbkMsT0FBTW5DLFNBQVMsSUFBSW9DLE1BQUosQ0FBVyxJQUFYLEVBQWlCM0UsUUFBakIsRUFBMkJ5RSxJQUEzQixFQUFpQ0MsUUFBakMsQ0FBZjtBQUNBLFFBQUs1RyxPQUFMLENBQWFrRyxJQUFiLENBQWtCekIsTUFBbEI7QUFDQSxVQUFPQSxNQUFQO0FBQ0E7OztnQ0FFb0I7QUFBQSxxQ0FBTnFDLElBQU07QUFBTkEsUUFBTTtBQUFBOztBQUNwQixPQUFNQyx1Q0FBUUMsUUFBUixpQkFBaUIsSUFBakIsR0FBMEJGLElBQTFCLEtBQU47QUFDQSxRQUFLN0csU0FBTCxDQUFlZ0gsR0FBZixDQUFtQkYsQ0FBbkI7QUFDQSxVQUFPQSxDQUFQO0FBQ0E7OztpQ0FFY3JFLFEsRUFBVTtBQUN4QixRQUFLekMsU0FBTCxDQUFlaUgsTUFBZixDQUFzQnhFLFFBQXRCO0FBQ0E7OztpQ0FFY2QsRyxFQUFLO0FBQ25CLFFBQUs5QixVQUFMLENBQWdCcUMsSUFBaEIsQ0FBcUJQLEdBQXJCO0FBQ0EsUUFBSzVCLE9BQUwsQ0FBYXlDLE9BQWIsQ0FBcUI7QUFBQSxXQUFVZ0MsT0FBT3RDLElBQVAsQ0FBWVAsR0FBWixDQUFWO0FBQUEsSUFBckI7QUFDQTs7O3dDQUVxQnVGLEksRUFHTjtBQUFBLE9BRmQ5SCxNQUVjLHVFQUZMLEtBQUtDLE9BRUE7QUFBQSxPQURkc0MsR0FDYyx1RUFEUnZDLE9BQU8rSCxVQUFQLENBQWtCLElBQWxCLENBQ1E7QUFBQSxPQUFkQyxLQUFjLHVFQUFOLElBQU07O0FBQ2YsT0FBSUEsS0FBSixFQUNDekYsSUFBSTBGLFNBQUosQ0FBYyxDQUFDLEVBQWYsRUFBbUIsQ0FBQyxFQUFwQixFQUF3QmpJLE9BQU9FLEtBQVAsR0FBZSxFQUF2QyxFQUEyQ0YsT0FBT0csTUFBUCxHQUFnQixFQUEzRDtBQUNELE9BQU0rSCxRQUFRaEYsS0FBS2lGLEdBQUwsQ0FDYm5JLE9BQU9FLEtBQVAsR0FBZSxLQUFLQSxLQURQLEVBRWJGLE9BQU9HLE1BQVAsR0FBZ0IsS0FBS0EsTUFGUixDQUFkO0FBR0FvQyxPQUFJNkYsSUFBSjtBQUNBN0YsT0FBSThGLFNBQUosQ0FBY3JJLE9BQU9FLEtBQVAsR0FBZSxDQUE3QixFQUFnQ0YsT0FBT0csTUFBUCxHQUFnQixDQUFoRDtBQUNBb0MsT0FBSTJGLEtBQUosQ0FBVUEsS0FBVixFQUFpQkEsS0FBakI7QUFDQTNGLE9BQUk4RixTQUFKLENBQWMsQ0FBQyxLQUFLbkksS0FBTixHQUFjLENBQTVCLEVBQStCLENBQUMsS0FBS0MsTUFBTixHQUFlLENBQTlDO0FBQ0EsT0FBSUgsVUFBVSxLQUFLQyxPQUFuQixFQUE0QjtBQUMzQixRQUFJLEtBQUtvSCxVQUFMLElBQW1CYSxLQUF2QixFQUNDSSxRQUFRQyxHQUFSLENBQVksZ0JBQWlCTCxRQUFRLEdBQXpCLEdBQWdDLFNBQTVDO0FBQ0QsU0FBS2IsVUFBTCxHQUFrQmEsS0FBbEI7QUFDQTtBQUNESixRQUFLdkYsR0FBTDtBQUNBQSxPQUFJaUcsT0FBSjtBQUNBOzs7NEJBRVMzRixRLEVBQVU7QUFDbkIsVUFBTyxLQUFLcEMsVUFBTCxDQUFnQmdJLFNBQWhCLENBQTBCNUYsUUFBMUIsQ0FBUDtBQUNBOzs7NEJBTVM7QUFDVCxRQUFLM0IsU0FBTCxDQUFlQyxhQUFmLEdBQ0MsSUFBSSxLQUFLRCxTQUFMLENBQWVDLGFBRHBCO0FBRUEsUUFBS0QsU0FBTCxDQUFlSSxLQUFmLEdBQXVCdkIsU0FBU2dHLFlBQWhDO0FBQ0E7Ozs0QkFFUztBQUFBOztBQUNULFFBQUsyQyxjQUFMOztBQURTLDhCQUVBL0IsS0FGQTtBQUdSLFdBQUtWLGdCQUFMLENBQXNCVSxLQUF0QixFQUE2QnZELE9BQTdCLENBQXFDO0FBQUEsWUFDcEMsT0FBS25ELE9BQUwsQ0FBYTBJLG1CQUFiLENBQWlDaEMsS0FBakMsRUFBd0NpQyxRQUF4QyxDQURvQztBQUFBLEtBQXJDO0FBSFE7O0FBRVQsUUFBSyxJQUFJakMsS0FBVCxJQUFrQixLQUFLVixnQkFBdkI7QUFBQSxVQUFTVSxLQUFUO0FBQUE7QUFHQTs7O3NCQWZtQjtBQUNuQixVQUFPLEtBQUtoRyxPQUFMLENBQWEsS0FBS08sU0FBTCxDQUFlQyxhQUE1QixDQUFQO0FBQ0E7Ozs7OztBQWdCRnBCLFNBQVNnQixPQUFULEdBQW1COEgsT0FBTyxVQUFQLENBQW5CO0FBQ0E5SSxTQUFTeUMsVUFBVCxHQUFzQnFHLE9BQU8sWUFBUCxDQUF0QjtBQUNBOUksU0FBU21DLFFBQVQsR0FBb0IyRyxPQUFPLGFBQVAsQ0FBcEI7QUFDQTlJLFNBQVNnRyxZQUFULEdBQXdCOEMsT0FBTyxjQUFQLENBQXhCO0FBQ0E5SSxTQUFTNEYsU0FBVCxHQUFxQmtELE9BQU8sV0FBUCxDQUFyQjs7QUFFQUMsU0FBUy9JLFFBQVQiLCJmaWxlIjoidW5pdmVyc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBVbml2ZXJzZSB7XG5cdGNvbnN0cnVjdG9yKGNhbnZhcykge1xuXHRcdHRoaXMuX2NhbnZhcyA9IGNhbnZhcztcblxuXHRcdHRoaXMud2lkdGggPSAxNDQwO1xuXHRcdHRoaXMuaGVpZ2h0ID0gNzY4O1xuXHRcdHRoaXMuY3JhdGVyU2l6ZSA9IDI1O1xuXHRcdHRoaXMucGxheWVyTWFyZ2luID0gMTAwO1xuXHRcdHRoaXMucGxheWVyUmFkaXVzID0gMjA7XG5cdFx0dGhpcy5tYXhTaG90VmVsb2NpdHkgPSA0MDA7XG5cdFx0dGhpcy5zaG90UG93ZXJVcFNwZWVkID0gdGhpcy5tYXhTaG90VmVsb2NpdHkgLyAyMDAwO1xuXG5cdFx0dGhpcy5zdGFyU3lzdGVtID0gbmV3IFN0YXJTeXN0ZW0odGhpcyk7XG5cdFx0dGhpcy5wbGF5ZXJzID0gW107XG5cdFx0dGhpcy5wYXJ0aWNsZXMgPSBuZXcgU2V0KCk7XG5cblx0XHRsZXQgX3N0YXRlID0gVW5pdmVyc2UuUFJFR0FNRSxcblx0XHRcdF9jdXJyZW50UGxheWVyID0gMDtcblx0XHRjb25zdCBzZWxmID0gdGhpcztcblx0XHR0aGlzLmdhbWVTdGF0ZSA9IHtcblx0XHRcdGdldCBjdXJyZW50UGxheWVyKCkgeyByZXR1cm4gX2N1cnJlbnRQbGF5ZXI7IH0sXG5cdFx0XHRzZXQgY3VycmVudFBsYXllcih2YWwpIHtcblx0XHRcdFx0X2N1cnJlbnRQbGF5ZXIgPSB2YWw7XG5cdFx0XHRcdHNlbGYuX3RyaWdnZXJFdmVudCgnY2hhbmdlLXBsYXllcicsIHZhbCk7XG5cdFx0XHR9LFxuXHRcdFx0Z2V0IHN0YXRlKCkgeyByZXR1cm4gX3N0YXRlOyB9LFxuXHRcdFx0c2V0IHN0YXRlKHZhbCkge1xuXHRcdFx0XHRfc3RhdGUgPSB2YWw7XG5cdFx0XHRcdHNlbGYuX3RyaWdnZXJFdmVudCgnc3RhdGUtY2hhbmdlJywgdmFsKTtcblx0XHRcdH0sXG5cdFx0XHRzaG90OiB7XG5cdFx0XHRcdGFuZ2xlOiBWZWN0b3IuemVybyxcblx0XHRcdFx0cG93ZXI6IDBcblx0XHRcdH1cblx0XHR9O1xuXHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0c2VsZi5fdHJpZ2dlckV2ZW50KCdzdGF0ZS1jaGFuZ2UnLCBfc3RhdGUpO1xuXHRcdFx0c2VsZi5fdHJpZ2dlckV2ZW50KCdjaGFuZ2UtcGxheWVyJywgX2N1cnJlbnRQbGF5ZXIpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy50aW1lc3RyZWFtID0gbmV3IFRpbWVzdHJlYW0oKTtcblx0XHR0aGlzLnRpbWVzdHJlYW0ubWF4SW50ZXJ2YWwgPSAxMDA7XG5cdFx0dGhpcy50aW1lc3RyZWFtLm9uKCdmcmFtZScsIGludGVydmFsID0+IHRoaXMud2l0aFRyYW5zZm9ybWVkQ2FudmFzKGN0eCA9PiB7XG5cdFx0XHRpZiAodGhpcy5nYW1lU3RhdGUuc3RhdGUgPT0gVW5pdmVyc2UuUE9XRVJJTkcpIHtcblx0XHRcdFx0dGhpcy5nYW1lU3RhdGUuc2hvdC5wb3dlciArPSB0aGlzLnNob3RQb3dlclVwU3BlZWQgKiBpbnRlcnZhbDtcblx0XHRcdFx0aWYgKHRoaXMuZ2FtZVN0YXRlLnNob3QucG93ZXIgPj0gdGhpcy5tYXhTaG90VmVsb2NpdHkpXG5cdFx0XHRcdFx0dGhpcy5nYW1lU3RhdGUuc2hvdC5wb3dlciA9IHRoaXMubWF4U2hvdFZlbG9jaXR5O1xuXHRcdFx0XHR0aGlzLnVwZGF0ZVNob3RBbmdsZSgpO1xuXHRcdFx0fVxuXHRcdFx0bGV0IG9uZ29pbmdTaG90ID0gZmFsc2U7XG5cdFx0XHR0aGlzLmRyYXdCYWNrZ3JvdW5kKGN0eCk7XG5cdFx0XHRpZiAodGhpcy5nYW1lU3RhdGUuc3RhdGUgPT0gVW5pdmVyc2UuVEFSR0VUVElORyB8fFxuXHRcdFx0XHR0aGlzLmdhbWVTdGF0ZS5zdGF0ZSA9PSBVbml2ZXJzZS5QT1dFUklORykge1xuXHRcdFx0XHRjdHguZmlsbFN0eWxlID0gJ3RyYW5zcGFyZW50Jztcblx0XHRcdFx0Y3R4LnN0cm9rZVN0eWxlID0gJyMwMGZmMDAnO1xuXHRcdFx0XHRjdHgubGluZVdpZHRoID0gMjtcblx0XHRcdFx0bmV3IENpcmNsZSh0aGlzLmN1cnJlbnRQbGF5ZXIubG9jYXRpb24sIDMwKS5kcmF3KGN0eCk7XG5cdFx0XHRcdG5ldyBMaW5lU2VnbWVudChcblx0XHRcdFx0XHRcdHRoaXMuY3VycmVudFBsYXllci5sb2NhdGlvblxuXHRcdFx0XHRcdFx0XHQucGx1cyh0aGlzLmdhbWVTdGF0ZS5zaG90LmFuZ2xlLnRpbWVzKDMwKSksXG5cdFx0XHRcdFx0XHR0aGlzLmN1cnJlbnRQbGF5ZXIubG9jYXRpb25cblx0XHRcdFx0XHRcdFx0LnBsdXModGhpcy5nYW1lU3RhdGUuc2hvdC5hbmdsZS50aW1lcygzMCArXG5cdFx0XHRcdFx0XHRcdFx0TWF0aC5tYXgoMTAsIHRoaXMuZ2FtZVN0YXRlLnNob3QucG93ZXJcblx0XHRcdFx0XHRcdFx0XHRcdC8gdGhpcy5tYXhTaG90VmVsb2NpdHkgKiAxMDApKSkpXG5cdFx0XHRcdFx0LmRyYXcoY3R4KTtcblx0XHRcdH1cblx0XHRcdHRoaXMucGFydGljbGVzLmZvckVhY2gocGFydGljbGUgPT4ge1xuXHRcdFx0XHRpZiAoaW50ZXJ2YWwgPT0gdGhpcy5tYXhJbnRlcnZhbCAmJlxuXHRcdFx0XHRcdHBhcnRpY2xlLmRpc3Bvc2FibGUpXG5cdFx0XHRcdFx0cGFydGljbGUuZGVzdHJveSgpO1xuXHRcdFx0XHRpZiAocGFydGljbGUuZGVzdHJveWVkKSB7XG5cdFx0XHRcdFx0dGhpcy5yZW1vdmVQYXJ0aWNsZShwYXJ0aWNsZSk7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNvbnN0IG1vdGlvbiA9IHBhcnRpY2xlLmFkdmFuY2UoXG5cdFx0XHRcdFx0XHRpbnRlcnZhbCAvIDEwMDAsIHRoaXMuc3RhclN5c3RlbSk7XG5cdFx0XHRcdGlmIChwYXJ0aWNsZS5jaGVja0NvbGxpc2lvbnMpIHtcblx0XHRcdFx0XHRjb25zdCBwbGFuZXRDb2xsaXNpb24gPSB0aGlzLnN0YXJTeXN0ZW0uY29sbGlzaW9uKFxuXHRcdFx0XHRcdFx0XHRtb3Rpb24sIHBhcnRpY2xlLnJhZGl1cyk7XG5cdFx0XHRcdFx0aWYgKHBsYW5ldENvbGxpc2lvbikge1xuXHRcdFx0XHRcdFx0cGFydGljbGUuaW1wYWN0KHBsYW5ldENvbGxpc2lvbik7XG5cdFx0XHRcdFx0XHRpZiAocGFydGljbGUuZGVzdHJveXNQbGFuZXQpIHtcblx0XHRcdFx0XHRcdFx0cGxhbmV0Q29sbGlzaW9uLm9ic3RhY2xlLmFkZENyYXRlcihcblx0XHRcdFx0XHRcdFx0XHRwbGFuZXRDb2xsaXNpb24ubG9jYXRpb24sXG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5jcmF0ZXJTaXplKTtcblx0XHRcdFx0XHRcdFx0Ly8gQml0cyBvZiBwbGFuZXRcblx0XHRcdFx0XHRcdFx0RXhwbG9zaW9ucy5zaW5nbGUodGhpcywgcGxhbmV0Q29sbGlzaW9uLmxvY2F0aW9uLFxuXHRcdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRcdHZlbG9jaXR5OiBWZWN0b3IuemVybyxcblx0XHRcdFx0XHRcdFx0XHRcdHZpb2xlbmNlOiA0MDAsXG5cdFx0XHRcdFx0XHRcdFx0XHRkZXN0cm95T25JbXBhY3Q6IHRydWUsXG5cdFx0XHRcdFx0XHRcdFx0XHRkZWJyaXNDb3VudDogMjUwLFxuXHRcdFx0XHRcdFx0XHRcdFx0bGlmZXRpbWU6IDEwMDAwMCxcblx0XHRcdFx0XHRcdFx0XHRcdGRlYnJpc1JhZGl1czogMyxcblx0XHRcdFx0XHRcdFx0XHRcdGdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbjogJ3NvdXJjZS1vdmVyJyxcblx0XHRcdFx0XHRcdFx0XHRcdGJhc2VDb2xvdXI6IGAke3BsYW5ldENvbGxpc2lvbi5vYnN0YWNsZS5odWV9LCA3NSUsIDQ1JWAsXG5cdFx0XHRcdFx0XHRcdFx0XHRjb2xvdXJNb2RlbDogJ2hzbCcsXG5cdFx0XHRcdFx0XHRcdFx0XHRzbW9vdGg6IGZhbHNlXG5cdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGlmIChwYXJ0aWNsZS5pc0J1bGxldCkge1xuXHRcdFx0XHRcdFx0b25nb2luZ1Nob3QgPSB0cnVlO1xuXHRcdFx0XHRcdFx0aWYgKHBhcnRpY2xlLmhhc0NsZWFyZWRTaG9vdGVyKVxuXHRcdFx0XHRcdFx0XHR0aGlzLnBsYXllcnMuZm9yRWFjaChwbGF5ZXIgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHBsYXllckNvbGxpc2lvbiA9XG5cdFx0XHRcdFx0XHRcdFx0XHRwbGF5ZXIuY29sbGlzaW9uKG1vdGlvbiwgcGFydGljbGUucmFkaXVzKTtcblx0XHRcdFx0XHRcdFx0XHRpZiAocGxheWVyQ29sbGlzaW9uKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRwbGF5ZXIuZXhwbG9kZSgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0cGFydGljbGUuaW1wYWN0KHBsYXllckNvbGxpc2lvbik7XG5cdFx0XHRcdFx0XHRcdFx0XHRkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lubmVyJylcblx0XHRcdFx0XHRcdFx0XHRcdFx0LmlubmVySFRNTCA9IHRoaXMub3RoZXJQbGF5ZXIocGxheWVyKS5uYW1lO1xuXHRcdFx0XHRcdFx0XHRcdFx0dGhpcy5nYW1lU3RhdGUuc3RhdGUgPSBVbml2ZXJzZS5HQU1FX09WRVI7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdGVsc2UgaWYgKHBhcnRpY2xlLmxvY2F0aW9uLmRpc3RhbmNlVG8ocGFydGljbGUub3duZXIubG9jYXRpb24pID5cblx0XHRcdFx0XHRcdFx0XHRwYXJ0aWNsZS5yYWRpdXMgKyBwYXJ0aWNsZS5vd25lci5oaXRBcmVhLnJhZGl1cylcblx0XHRcdFx0XHRcdFx0cGFydGljbGUuaGFzQ2xlYXJlZFNob290ZXIgPSB0cnVlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0XHRwYXJ0aWNsZS5kcmF3KGN0eCk7XG5cdFx0XHR9KTtcblx0XHRcdGlmICghb25nb2luZ1Nob3QgJiZcblx0XHRcdFx0dGhpcy5nYW1lU3RhdGUuc3RhdGUgPT0gVW5pdmVyc2UuT05HT0lOR19TSE9UKSB7XG5cdFx0XHRcdHRoaXMuZ2FtZVN0YXRlLnN0YXRlID0gVW5pdmVyc2UuVEFSR0VUVElORztcblx0XHRcdFx0dGhpcy5nYW1lU3RhdGUuc2hvdC5wb3dlciA9IDA7XG5cdFx0XHR9XG5cdFx0fSkpO1xuXG5cdFx0dGhpcy5hZGRQbGF5ZXIoXG5cdFx0XHRuZXcgVmVjdG9yKHRoaXMucGxheWVyTWFyZ2luLCB0aGlzLmhlaWdodCAvIDIpLFxuXHRcdFx0dGhpcy5wbGF5ZXJSYWRpdXMsXG5cdFx0XHQnaW1nL3NoaXAxLnBuZycpXG5cdFx0XHRcdC5uYW1lID0gJ1BsYXllciBPbmUnO1xuXHRcdHRoaXMuYWRkUGxheWVyKFxuXHRcdFx0bmV3IFZlY3Rvcih0aGlzLndpZHRoIC0gdGhpcy5wbGF5ZXJNYXJnaW4sIHRoaXMuaGVpZ2h0IC8gMiksXG5cdFx0XHR0aGlzLnBsYXllclJhZGl1cyxcblx0XHRcdCdpbWcvc2hpcDIucG5nJylcblx0XHRcdFx0Lm5hbWUgPSAnUGxheWVyIFR3byc7XG5cblx0XHR0aGlzLl9jYW52YXNMaXN0ZW5lcnMgPSB7fTtcblxuXHRcdHRoaXMuYWRkQ2FudmFzTGlzdGVuZXIoJ21vdXNlZG93bicsIGUgPT4ge1xuXHRcdFx0aWYgKHRoaXMuZ2FtZVN0YXRlLnN0YXRlID09IFVuaXZlcnNlLlRBUkdFVFRJTkcpIHtcblx0XHRcdFx0dGhpcy5nYW1lU3RhdGUuc2hvdC5wb3dlciA9IDA7XG5cdFx0XHRcdHRoaXMudXBkYXRlU2hvdEFuZ2xlKGUpO1xuXHRcdFx0XHR0aGlzLmdhbWVTdGF0ZS5zdGF0ZSA9IFVuaXZlcnNlLlBPV0VSSU5HO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0dGhpcy5hZGRDYW52YXNMaXN0ZW5lcignbW91c2V1cCcsIGUgPT4ge1xuXHRcdFx0aWYgKHRoaXMuZ2FtZVN0YXRlLnN0YXRlICE9IFVuaXZlcnNlLlBPV0VSSU5HKVxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR0aGlzLnVwZGF0ZVNob3RBbmdsZShlKTtcblx0XHRcdGlmICh0aGlzLmdhbWVTdGF0ZS5zaG90LnBvd2VyID49IHRoaXMubWF4U2hvdFZlbG9jaXR5KVxuXHRcdFx0XHR0aGlzLmdhbWVTdGF0ZS5zaG90LnBvd2VyID0gdGhpcy5tYXhTaG90VmVsb2NpdHk7XG5cdFx0XHR0aGlzLmN1cnJlbnRQbGF5ZXIuc2hvb3QodGhpcy5nYW1lU3RhdGUuc2hvdC5hbmdsZVxuXHRcdFx0XHRcdC50aW1lcyh0aGlzLmdhbWVTdGF0ZS5zaG90LnBvd2VyKSk7XG5cdFx0XHR0aGlzLmVuZFR1cm4oKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuYWRkQ2FudmFzTGlzdGVuZXIoJ21vdXNlb3V0JywgZSA9PiB7XG5cdFx0XHRpZiAodGhpcy5nYW1lU3RhdGUuc3RhdGUgPT0gVW5pdmVyc2UuUE9XRVJJTkcpXG5cdFx0XHRcdHRoaXMuZ2FtZVN0YXRlLnN0YXRlID0gVW5pdmVyc2UuVEFSR0VUVElORztcblx0XHR9KTtcblxuXHRcdHRoaXMuYWRkQ2FudmFzTGlzdGVuZXIoJ21vdXNlbW92ZScsIGUgPT4ge1xuXHRcdFx0aWYgKHRoaXMuZ2FtZVN0YXRlLnN0YXRlID09IFVuaXZlcnNlLlBPV0VSSU5HIHx8XG5cdFx0XHRcdHRoaXMuZ2FtZVN0YXRlLnN0YXRlID09IFVuaXZlcnNlLlRBUkdFVFRJTkcpXG5cdFx0XHRcdHRoaXMudXBkYXRlU2hvdEFuZ2xlKGUpO1xuXHRcdH0pO1xuXHR9XG5cblx0c3RhcnRHYW1lKCkge1xuXHRcdHRoaXMuZ2FtZVN0YXRlLnN0YXRlID0gVW5pdmVyc2UuVEFSR0VUVElORztcblx0fVxuXG5cdHVwZGF0ZVNob3RBbmdsZShlKSB7XG5cdFx0aWYgKGUpIHtcblx0XHRcdHRoaXMuZ2FtZVN0YXRlLnNob3QuYW5nbGUgPSB0aGlzLm1vdXNlVmVjdG9yKGUpXG5cdFx0XHRcdC5taW51cyh0aGlzLmN1cnJlbnRQbGF5ZXIubG9jYXRpb24pXG5cdFx0XHRcdC5ub3JtYWxpc2UoKTtcblx0XHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaG90LWFuZ2xlJykuaW5uZXJIVE1MID1cblx0XHRcdFx0TWF0aC5yb3VuZCh0aGlzLmdhbWVTdGF0ZS5zaG90LmFuZ2xlLmFuZ2xlXG5cdFx0XHRcdFx0KiAxODAgLyBNYXRoLlBJKTtcblx0XHR9XG5cdFx0ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Nob3QtcG93ZXInKS5pbm5lckhUTUwgPVxuXHRcdFx0TWF0aC5yb3VuZCh0aGlzLmdhbWVTdGF0ZS5zaG90LnBvd2VyXG5cdFx0XHRcdCogMTAwIC8gdGhpcy5tYXhTaG90VmVsb2NpdHkpO1xuXHR9XG5cblx0YWRkQ2FudmFzTGlzdGVuZXIoZXZlbnQsIGNhbGxiYWNrKSB7XG5cdFx0aWYgKCF0aGlzLl9jYW52YXNMaXN0ZW5lcnNbZXZlbnRdKVxuXHRcdFx0dGhpcy5fY2FudmFzTGlzdGVuZXJzW2V2ZW50XSA9IFtdO1xuXHRcdHRoaXMuX2NhbnZhc0xpc3RlbmVyc1tldmVudF0ucHVzaChjYWxsYmFjayk7XG5cdFx0dGhpcy5fY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGNhbGxiYWNrKTtcblx0fVxuXG5cdG90aGVyUGxheWVyKHBsYXllcikge1xuXHRcdHJldHVybiB0aGlzLnBsYXllcnNbMSAtIHRoaXMucGxheWVycy5pbmRleE9mKHBsYXllcildO1xuXHR9XG5cblx0bW91c2VUb1Nob3QoZSkge1xuXHRcdGNvbnN0IG1vdXNlID0gdGhpcy5tb3VzZVZlY3RvcihlKTtcblx0XHRsZXQgc2hvdCA9IG1vdXNlLm1pbnVzKHRoaXMuY3VycmVudFBsYXllci5sb2NhdGlvbilcblx0XHRcdFx0LnRpbWVzKHRoaXMuc2hvdFZlbGljaXR5TXVsdGlwbGllcik7XG5cdFx0aWYgKHNob3QubGVuZ3RoID4gdGhpcy5tYXhTaG90VmVsb2NpdHkpXG5cdFx0XHRzaG90ID0gc2hvdC5ub3JtYWxpc2UoKS50aW1lcyh0aGlzLm1heFNob3RWZWxvY2l0eSk7XG5cdFx0cmV0dXJuIHNob3Q7XG5cdH1cblxuXHRtb3VzZVZlY3RvcihlKSB7XG5cdFx0cmV0dXJuIFZlY3Rvci5jYW52YXNNb3VzZVZlY3Rvcih0aGlzLl9jYW52YXMsIGUpXG5cdFx0XHQubWludXMobmV3IFZlY3Rvcih0aGlzLl9jYW52YXMud2lkdGggLyAyLCB0aGlzLl9jYW52YXMuaGVpZ2h0IC8gMikpXG5cdFx0XHQub3Zlcih0aGlzLl9sYXN0U2NhbGUgfHwgMSlcblx0XHRcdC5wbHVzKG5ldyBWZWN0b3IodGhpcy53aWR0aCAvIDIsIHRoaXMuaGVpZ2h0IC8gMikpO1xuXHR9XG5cblx0YWRkUGxheWVyKGxvY2F0aW9uLCBzaXplLCBmaWxlbmFtZSkge1xuXHRcdGNvbnN0IHBsYXllciA9IG5ldyBQbGF5ZXIodGhpcywgbG9jYXRpb24sIHNpemUsIGZpbGVuYW1lKTtcblx0XHR0aGlzLnBsYXllcnMucHVzaChwbGF5ZXIpO1xuXHRcdHJldHVybiBwbGF5ZXI7XG5cdH1cblxuXHRhZGRQYXJ0aWNsZSguLi5hcmdzKSB7XG5cdFx0Y29uc3QgcCA9IG5ldyBQYXJ0aWNsZSh0aGlzLCAuLi5hcmdzKTtcblx0XHR0aGlzLnBhcnRpY2xlcy5hZGQocCk7XG5cdFx0cmV0dXJuIHA7XG5cdH1cblxuXHRyZW1vdmVQYXJ0aWNsZShwYXJ0aWNsZSkge1xuXHRcdHRoaXMucGFydGljbGVzLmRlbGV0ZShwYXJ0aWNsZSk7XG5cdH1cblxuXHRkcmF3QmFja2dyb3VuZChjdHgpIHtcblx0XHR0aGlzLnN0YXJTeXN0ZW0uZHJhdyhjdHgpO1xuXHRcdHRoaXMucGxheWVycy5mb3JFYWNoKHBsYXllciA9PiBwbGF5ZXIuZHJhdyhjdHgpKTtcblx0fVxuXG5cdHdpdGhUcmFuc2Zvcm1lZENhbnZhcyhjb2RlLFxuXHRcdFx0Y2FudmFzID0gdGhpcy5fY2FudmFzLFxuXHRcdFx0Y3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksXG5cdFx0XHRjbGVhciA9IHRydWUpIHtcblx0XHRpZiAoY2xlYXIpXG5cdFx0XHRjdHguY2xlYXJSZWN0KC0xMCwgLTEwLCBjYW52YXMud2lkdGggKyAyMCwgY2FudmFzLmhlaWdodCArIDIwKTtcblx0XHRjb25zdCBzY2FsZSA9IE1hdGgubWluKFxuXHRcdFx0Y2FudmFzLndpZHRoIC8gdGhpcy53aWR0aCxcblx0XHRcdGNhbnZhcy5oZWlnaHQgLyB0aGlzLmhlaWdodCk7XG5cdFx0Y3R4LnNhdmUoKTtcblx0XHRjdHgudHJhbnNsYXRlKGNhbnZhcy53aWR0aCAvIDIsIGNhbnZhcy5oZWlnaHQgLyAyKTtcblx0XHRjdHguc2NhbGUoc2NhbGUsIHNjYWxlKTtcblx0XHRjdHgudHJhbnNsYXRlKC10aGlzLndpZHRoIC8gMiwgLXRoaXMuaGVpZ2h0IC8gMik7XG5cdFx0aWYgKGNhbnZhcyA9PSB0aGlzLl9jYW52YXMpIHtcblx0XHRcdGlmICh0aGlzLl9sYXN0U2NhbGUgIT0gc2NhbGUpXG5cdFx0XHRcdGNvbnNvbGUubG9nKCdWaWV3aW5nIGF0ICcgKyAoc2NhbGUgKiAxMDApICsgJyUgc2NhbGUnKTtcblx0XHRcdHRoaXMuX2xhc3RTY2FsZSA9IHNjYWxlO1xuXHRcdH1cblx0XHRjb2RlKGN0eCk7XG5cdFx0Y3R4LnJlc3RvcmUoKTtcblx0fVxuXG5cdGdyYXZpdHlBdChsb2NhdGlvbikge1xuXHRcdHJldHVybiB0aGlzLnN0YXJTeXN0ZW0uZ3Jhdml0eUF0KGxvY2F0aW9uKTtcblx0fVxuXG5cdGdldCBjdXJyZW50UGxheWVyKCkge1xuXHRcdHJldHVybiB0aGlzLnBsYXllcnNbdGhpcy5nYW1lU3RhdGUuY3VycmVudFBsYXllcl07XG5cdH1cblxuXHRlbmRUdXJuKCkge1xuXHRcdHRoaXMuZ2FtZVN0YXRlLmN1cnJlbnRQbGF5ZXIgPVxuXHRcdFx0MSAtIHRoaXMuZ2FtZVN0YXRlLmN1cnJlbnRQbGF5ZXI7XG5cdFx0dGhpcy5nYW1lU3RhdGUuc3RhdGUgPSBVbml2ZXJzZS5PTkdPSU5HX1NIT1Q7XG5cdH1cblxuXHRkZXN0cm95KCkge1xuXHRcdHRoaXMuX2NhbmNlbFVwZGF0ZXMoKTtcblx0XHRmb3IgKGxldCBldmVudCBpbiB0aGlzLl9jYW52YXNMaXN0ZW5lcnMpXG5cdFx0XHR0aGlzLl9jYW52YXNMaXN0ZW5lcnNbZXZlbnRdLmZvckVhY2gobGlzdGVuZXIgPT5cblx0XHRcdFx0dGhpcy5fY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKSk7XG5cdH1cbn1cblxuVW5pdmVyc2UuUFJFR0FNRSA9IFN5bWJvbCgnUHJlLWdhbWUnKTtcblVuaXZlcnNlLlRBUkdFVFRJTkcgPSBTeW1ib2woJ1RhcmdldHRpbmcnKTtcblVuaXZlcnNlLlBPV0VSSU5HID0gU3ltYm9sKCdQb3dlcmluZyBVcCcpO1xuVW5pdmVyc2UuT05HT0lOR19TSE9UID0gU3ltYm9sKCdPbmdvaW5nIFNob3QnKTtcblVuaXZlcnNlLkdBTUVfT1ZFUiA9IFN5bWJvbCgnR2FtZSBPdmVyJyk7XG5cbmV2ZW50aXNlKFVuaXZlcnNlKTtcbiJdfQ==